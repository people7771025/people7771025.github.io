<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>投資組合每日追蹤（台股＋上櫃＋興櫃＋美股＋現金）</title>
  <!-- 圖表 & CSV 解析 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- 字型 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--card:#121a36;--text:#e7ecff;--muted:#9fb0ff;--grid:#2a355f}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto}
    header{padding:20px 16px;border-bottom:1px solid var(--grid);position:sticky;top:0;background:linear-gradient(180deg,#0b1020 70%,#0b102000);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:16px;padding:16px;box-shadow:0 10px 30px #0004}
    h1{font-size:24px;margin:0 0 6px;font-weight:800}
    h2{font-size:16px;margin:0 0 12px;color:var(--muted);font-weight:600}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,button{background:#0f1630;color:var(--text);border:1px solid var(--grid);border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi .item{background:#0f1630;border:1px solid var(--grid);border-radius:12px;padding:12px}
    .kpi .v{font-size:20px;font-weight:800}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .pill{padding:6px 10px;border-radius:999px;background:#0f1630;border:1px solid var(--grid);font-size:12px;cursor:pointer}
    a{color:#b9c6ff}
    footer{opacity:.7;padding:24px;text-align:center}
    canvas{width:100%;height:360px}
    .hint{font-size:12px;color:#cbd5ff}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>投資組合每日追蹤（免費版）</h1>
    <div class="row">
      <label>資料來源：
        <a id="sheetLink" target="_blank" rel="noopener">尚未設定</a>
      </label>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card">
      <h2>淨值走勢（上市／上櫃／興櫃／美股／現金）</h2>
      <canvas id="equityChart"></canvas>
      <div class="legend" id="legend"></div>
      <div class="hint">提示：點擊下方標籤可開關各資產線。</div>
    </section>

    <aside class="grid">
      <section class="card">
        <h2>摘要（最近一日）</h2>
        <div class="kpi">
          <div class="item">
            <div class="l">總資產</div>
            <div class="v" id="kpi-total">—</div>
            <div class="l" id="kpi-date">—</div>
          </div>
          <div class="item">
            <div class="l">日變動</div>
            <div class="v" id="kpi-day">—</div>
            <div class="l" id="kpi-daypct">—</div>
          </div>
          <div class="item">
            <div class="l">今年以來</div>
            <div class="v" id="kpi-ytd">—</div>
            <div class="l" id="kpi-ytdpct">—</div>
          </div>
        </div>
      </section>
      <section class="card">
        <h2>設定</h2>
        <div class="row" style="gap:6px 8px">
          <label for="csvUrl">CSV 來源（History 分頁）</label>
          <input id="csvUrl" placeholder="貼上試算表 History 的 CSV 連結" style="flex:1;min-width:260px" />
          <button id="save">儲存</button>
        </div>
        <p class="hint">
          試算表 → 檔案 → 發佈到網路 → 選 <b>History</b> 分頁 → 格式 <b>CSV</b> → 複製連結貼上。
          若遇到快取問題，可在連結後加 <code>&amp;_ts=</code> + 今天日期。
        </p>
      </section>
    </aside>
  </main>

  <footer>
    <small>以 Chart.js + PapaParse + Google 試算表（CSV）驅動。資料每日更新；非即時。</small>
  </footer>

<script>
(function(){
  // ====== 狀態與工具 ======
  const state = { csv: localStorage.getItem('pf_csv') || '' }
  const $ = (id)=>document.getElementById(id)
  const csvInput = $('csvUrl'), saveBtn = $('save'), sheetLink = $('sheetLink'), legendBox = $('legend')
  let chart

  function fmtNTD(n){
    if(n===undefined||n===null||isNaN(n)) return '—'
    return n.toLocaleString('zh-TW',{style:'currency',currency:'TWD',maximumFractionDigits:0})
  }
  function pct(v){ return (v>=0?'+':'') + (v*100).toFixed(2) + '%' }

  async function fetchCSV(url){
    const r = await fetch(url, {cache:'no-store'})
    if(!r.ok) throw new Error('CSV fetch failed: '+r.status)
    return r.text()
  }

  // ====== 載入 CSV 並畫圖 ======
  async function load(){
    if(!state.csv){ sheetLink.textContent='尚未設定'; sheetLink.removeAttribute('href'); return }
    sheetLink.href = state.csv; sheetLink.textContent = 'Google 試算表（CSV）'

    const txt = await fetchCSV(state.csv)
    const parsed = Papa.parse(txt,{header:true,skipEmptyLines:true})
    if(parsed.errors && parsed.errors.length){
      console.warn(parsed.errors.slice(0,3))
    }
    const rows = parsed.data

    // 預期欄位：date,total_twd,twse_twd,tpex_twd,emerging_twd,us_twd,cash_twd
    const labels = []
    const series = { total:[], twse:[], tpex:[], emerging:[], us:[], cash:[] }

    for(const r of rows){
      labels.push(r.date)
      series.total.push(Number(r.total_twd||0))
      series.twse.push(Number(r.twse_twd||0))
      series.tpex.push(Number(r.tpex_twd||0))
      series.emerging.push(Number(r.emerging_twd||0))
      series.us.push(Number(r.us_twd||0))
      series.cash.push(Number(r.cash_twd||0))
    }

    // KPI
    if(rows.length){
      const last = rows[rows.length-1]
      const prev = rows[rows.length-2] || last
      const y0 = rows.find(x=> (x.date||'').slice(0,4)===(last.date||'').slice(0,4)) || rows[0]
      const L = Number(last.total_twd||0), P = Number(prev.total_twd||0), Y = Number(y0.total_twd||0)
      $('kpi-total').textContent = fmtNTD(L)
      $('kpi-date').textContent = last.date || '—'
      $('kpi-day').textContent = fmtNTD(L-P)
      $('kpi-daypct').textContent = P>0 ? pct((L-P)/P) : '—'
      $('kpi-ytd').textContent = fmtNTD(L-Y)
      $('kpi-ytdpct').textContent = Y>0 ? pct((L-Y)/Y) : '—'
    }

    // 繪圖
    const ds = (label,data)=>({label,data,borderWidth:2,pointRadius:0,tension:.25})
    const datasets = [
      ds('總資產', series.total),
      ds('台股上市', series.twse),
      ds('上櫃', series.tpex),
      ds('興櫃', series.emerging),
      ds('美股(折台幣)', series.us),
      ds('現金', series.cash),
    ]
    chart?.destroy()
    chart = new Chart($('equityChart'),{
      type:'line',
      data:{labels,datasets},
      options:{
        responsive:true, maintainAspectRatio:false,
        interaction:{mode:'index',intersect:false},
        scales:{
          x:{grid:{color:'rgba(255,255,255,.06)'}},
          y:{grid:{color:'rgba(255,255,255,.06)'},ticks:{callback:v=>v.toLocaleString('zh-TW')}}
        },
        plugins:{
          legend:{display:false},
          tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${fmtNTD(ctx.raw)}`}}
        }
      }
    })

    // 圖例（可點擊顯示/隱藏）
    legendBox.innerHTML=''
    datasets.forEach((d,idx)=>{
      const el=document.createElement('button')
      el.className='pill'
      el.textContent=d.label
      el.onclick=()=>{ chart.setDatasetVisibility(idx, !chart.isDatasetVisible(idx)); chart.update() }
      legendBox.appendChild(el)
    })
  }

  // 儲存 CSV 連結
  saveBtn.onclick = ()=>{ state.csv = csvInput.value.trim(); localStorage.setItem('pf_csv', state.csv); load() }

  // 初始化
  if(state.csv){ csvInput.value = state.csv; load().catch(e=>{console.error(e); alert('載入 CSV 失敗，請檢查連結是否公開且為 History 分頁的 CSV。')}) }
})();
</script>
</body>
</html>
